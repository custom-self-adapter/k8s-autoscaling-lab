nodeSelector:
  monitoring: "yes"

prometheus:
  url: http://kube-prometheus-stack-prometheus.monitoring

rules:
  default: false
  external:
    - seriesQuery: '{__name__="nginx_ingress_controller_request_duration_seconds_bucket",namespace!=""}'
      resources:
        template: <<.Resource>>
        overrides:
          exported_namespace:
            resource: "namespace"
          ingress:
            resource: "ingress"
      name:
        as: nginx_ingress_p95_ms
      metricsQuery: >
        histogram_quantile(
          0.95,
          sum(rate(
            <<.Series>>{<<.LabelMatchers>>}[1m]
          )) by (le)
        ) * 1000
    - seriesQuery: 'nginx_ingress_controller_request_duration_seconds_count{ingress!=""}'
      resources:
        overrides:
          exported_namespace:
            resource: "namespace"
          ingress:
            resource: "ingress"
      name:
        as: "nginx_ingress_avg_ms"
      metricsQuery: |
        sum by (ingress, exported_namespace) (
          rate(nginx_ingress_controller_request_duration_seconds_sum{<<.LabelMatchers>>}[1m])
        )
        /
        sum by (ingress, exported_namespace) (
          rate(nginx_ingress_controller_request_duration_seconds_count{<<.LabelMatchers>>}[1m])
        ) * 1000

